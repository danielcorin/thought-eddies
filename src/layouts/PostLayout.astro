---
import Navigation from "@components/layout/Navigation.astro";
import RecommendedContent from "@components/RecommendedContent.astro";
import Tag from "@components/Tag.astro";
import ArticleMetadata from "@components/ArticleMetadata.astro";
import { findSimilarContent } from "@utils/findSimilarContent";
import { Icon } from "astro-icon/components";
import { getCollection, getEntry } from "astro:content";
import Layout from "./Layout.astro";
import FullscreenImageViewer from "@components/FullscreenImageViewer.astro";
import ClickableImages from "@components/ClickableImages.astro";
import BlueskyComments from "@components/BlueskyComments.tsx";
import { promises as fs } from 'fs';
import path from 'path';
import { getCommitUrl } from '@utils/git';
import { slugify } from '@utils/slugify';

const { frontmatter, ogImage, slug } = Astro.props;

// Determine collection type
const collectionType = frontmatter.collection || "posts";
const isTil = collectionType === "til";
const isProject = collectionType === "projects";
const isRss = collectionType === "rss";

// Get the current entry using the slug
const entryId = slug.replace(/\.(md|mdx)$/, '');
const currentEntry = await getEntry(collectionType, entryId);

// Check if timeline exists for projects
let hasTimeline = false;
if (isProject) {
  const timelinePath = path.join(
    process.cwd(),
    'src/content/projects',
    entryId,
    'timeline'
  );
  try {
    await fs.access(timelinePath);
    hasTimeline = true;
  } catch {
    hasTimeline = false;
  }
}

// Get all posts/tils to find prev/next
const allEntries = await getCollection(collectionType);
const sortedEntries = allEntries
  .filter((entry) => !entry.data.draft)
  .sort(
    (a, b) => {
      // RSS content uses 'date' field, others use 'createdAt'
      const dateA = isRss ? a.data.date : a.data.createdAt;
      const dateB = isRss ? b.data.date : b.data.createdAt;
      return new Date(dateB).getTime() - new Date(dateA).getTime();
    },
  );

// Find current entry index using the ID instead of title
const currentIndex = sortedEntries.findIndex(
  (entry) => entry.id === currentEntry?.id,
);

const prevEntry =
  currentIndex < sortedEntries.length - 1 ? sortedEntries[currentIndex + 1] : null;
const nextEntry = currentIndex > 0 ? sortedEntries[currentIndex - 1] : null;

// Get all posts and TILs for recommendations
const allPosts = await getCollection('posts');
const allTils = await getCollection('til');

// Find similar entries, excluding prev and next
const excludeEntries = [prevEntry, nextEntry].filter(Boolean) as typeof sortedEntries;
const similarContent = currentEntry
  ? findSimilarContent(currentEntry, allPosts, allTils, 3, excludeEntries)
  : [];

// Get commit URL for the current file
const repoUrl = 'https://github.com/danielcorin/thought-eddies';
const commitUrl = currentEntry ? getCommitUrl(currentEntry.filePath, repoUrl) : null;
---

<Layout title={frontmatter.title} ogImage={ogImage} pageType={isProject ? "projects" : isTil ? "til" : isRss ? "rss" : "posts"}>
  <Navigation selected={isProject ? "projects" : isTil ? "til" : isRss ? "rss" : "posts"} />
  <article>
    <header>
      <h1>{frontmatter.title}</h1>
      <ArticleMetadata
        createdAt={frontmatter.createdAt}
        updatedAt={frontmatter.updatedAt}
        location={frontmatter.location}
        category={isTil ? frontmatter.category : undefined}
        categoryHref={isTil && frontmatter.category ? `/til/${frontmatter.category}` : undefined}
        series={frontmatter.series}
        seriesHref={frontmatter.series ? `/series/${slugify(frontmatter.series)}` : undefined}
        githubUrl={frontmatter.githubUrl}
        projectUrl={frontmatter.projectUrl}
        timelineHref={isProject && hasTimeline ? `/projects/${entryId}/timeline` : undefined}
      />
      {
        frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="tags">
            {frontmatter.tags.map((tag: string) => (
              <Tag tag={tag} />
            ))}
          </div>
        )
      }
    </header>
    <div class="content">
      <ClickableImages>
        <slot />
      </ClickableImages>
    </div>

    <div class="raw-link">
      <a href={
        isTil
          ? `/til/${slug.replace(/\.(md|mdx)$/, '')}/index.md`
          : isProject
          ? `/projects/${slug.replace(/\.(md|mdx)$/, '')}/index.md`
          : isRss
          ? `/rss/${slug.replace(/\.(md|mdx)$/, '')}/index.md`
          : `/posts/${slug.replace(/\.(md|mdx)$/, '')}/index.md`
      } class="raw-button">
        <Icon name="ph:code" />
        <span>raw</span>
      </a>
      <a href={`https://github.com/danielcorin/thought-eddies/edit/main/${currentEntry?.filePath || `src/content/${collectionType}/${slug}`}`} target="_blank" rel="noopener noreferrer" class="edit-button">
        <Icon name="ph:pencil-simple" />
        <span>edit</span>
      </a>
      {commitUrl && (
        <a href={commitUrl} target="_blank" rel="noopener noreferrer" class="commit-button">
          <Icon name="ph:git-commit" />
          <span>commit</span>
        </a>
      )}
    </div>

    <RecommendedContent content={similarContent} />

    {frontmatter.bsky && (
      <BlueskyComments uri={frontmatter.bsky} client:visible />
    )}

    <nav class="post-navigation">
      <div class="nav-item nav-prev-wrapper">
        {
          prevEntry && (
            <a href={
              isTil ? `/til/${prevEntry.id.split('/')[0]}/${prevEntry.id.split('/').slice(1).join('/').replace(/\.(md|mdx)$/, '')}?ref=arrow_nav` :
              isProject ? `/projects/${prevEntry.id}?ref=arrow_nav` :
              isRss ? `/rss/${prevEntry.id}?ref=arrow_nav` :
              `/posts/${prevEntry.id}?ref=arrow_nav`
            } class="nav-prev">
              <Icon name="ph:arrow-left" />
              <div class="nav-content">
                <span class="nav-label">Previous</span>
                <span class="nav-title">{prevEntry.data.title}</span>
              </div>
            </a>
          )
        }
      </div>
      <div class="nav-item nav-next-wrapper">
        {
          nextEntry && (
            <a href={
              isTil ? `/til/${nextEntry.id.split('/')[0]}/${nextEntry.id.split('/').slice(1).join('/').replace(/\.(md|mdx)$/, '')}?ref=arrow_nav` :
              isProject ? `/projects/${nextEntry.id}?ref=arrow_nav` :
              isRss ? `/rss/${nextEntry.id}?ref=arrow_nav` :
              `/posts/${nextEntry.id}?ref=arrow_nav`
            } class="nav-next">
              <div class="nav-content">
                <span class="nav-label">Next</span>
                <span class="nav-title">{nextEntry.data.title}</span>
              </div>
              <Icon name="ph:arrow-right" />
            </a>
          )
        }
      </div>
    </nav>
  </article>
</Layout>

<FullscreenImageViewer />
<style>
  .post-navigation {
    display: flex;
    justify-content: space-between;
    align-items: stretch;
    margin-top: var(--spacing-xl);
    gap: var(--spacing-lg);
  }

  .nav-item {
    flex: 1;
    display: flex;
  }

  .nav-prev-wrapper {
    justify-content: flex-start;
  }

  .nav-next-wrapper {
    justify-content: flex-end;
  }

  .nav-prev,
  .nav-next {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md) var(--spacing-lg);
    padding-left: 3rem;
    padding-right: 3rem;
    background: var(--color-bg-code);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: background 0.2s;
    max-width: 320px;
    position: relative;
  }

  .nav-prev:hover,
  .nav-next:hover {
    background: var(--color-bg-hover);
  }

  .nav-prev svg,
  .nav-next svg {
    width: 1.5rem;
    height: 1.5rem;
    flex-shrink: 0;
    color: var(--color-ink-light);
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
  }

  .nav-prev svg {
    left: var(--spacing-md);
  }

  .nav-next svg {
    right: var(--spacing-md);
  }

  .nav-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-align: center;
  }

  .nav-label {
    font-size: var(--text-sm);
    color: var(--color-ink-light);
    font-family: var(--font-mono);
  }

  .nav-title {
    font-size: var(--text-base);
    color: var(--color-ink);
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  @media (max-width: 768px) {
    .post-navigation {
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .nav-prev,
    .nav-next {
      width: 100%;
      max-width: 100%;
    }
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .raw-link {
    display: flex;
    justify-content: flex-start;
    gap: 0.75rem;
    margin-top: var(--spacing-xl);
  }

  .raw-button,
  .edit-button,
  .commit-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-bg-code);
    color: var(--color-ink);
    text-decoration: none;
    border-radius: 0.25rem;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    transition: background 0.2s, color 0.2s;
  }

  .raw-button:hover,
  .edit-button:hover,
  .commit-button:hover {
    background: var(--color-bg-hover);
    color: var(--color-accent);
  }

  .raw-button svg,
  .edit-button svg,
  .commit-button svg {
    width: 1rem;
    height: 1rem;
  }
</style>

<script>
  // Add keyboard navigation support
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") {
      const prevLink = document.querySelector(".nav-prev") as HTMLAnchorElement;
      if (prevLink) {
        prevLink.click();
      }
    } else if (e.key === "ArrowRight") {
      const nextLink = document.querySelector(".nav-next") as HTMLAnchorElement;
      if (nextLink) {
        nextLink.click();
      }
    }
  });
</script>
