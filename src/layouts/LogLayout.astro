---
import Navigation from "@components/layout/Navigation.astro";
import Tag from "@components/Tag.astro";
import ArticleMetadata from "@components/ArticleMetadata.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import Layout from "./Layout.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import ClickableImages from "@components/ClickableImages.astro";
import FullscreenImageViewer from "@components/FullscreenImageViewer.astro";
import { getCommitUrl } from '@utils/git';
import {
  getLogDateComponents,
  formatLogFullDate,
  MONTH_NAMES,
  SHORT_MONTH_NAMES,
} from '@utils/markdownEndpoints';

const { frontmatter, ogImage, slug } = Astro.props;

// Parse date from slug to avoid timezone issues (slug is like "2025/12/10" or "2025/12/10.mdx")
const { year: logYear, month: logMonth, day: logDay } = getLogDateComponents(
  slug,
  new Date(frontmatter.date)
);

// Get all logs to find prev/next
const allLogs = await getCollection("logs");
const sortedLogs = allLogs
  .filter((log) => !log.data.draft)
  .sort(
    (a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime(),
  );

// Find current log index
const currentLogDate = new Date(frontmatter.date).toISOString().split("T")[0];
const currentIndex = sortedLogs.findIndex(
  (log) =>
    new Date(log.data.date).toISOString().split("T")[0] === currentLogDate,
);

const prevLog = currentIndex > 0 ? sortedLogs[currentIndex - 1] : null;
const nextLog =
  currentIndex < sortedLogs.length - 1 ? sortedLogs[currentIndex + 1] : null;

// Find the current log object
const currentLog = sortedLogs[currentIndex];

// Get commit URL for the current file
const repoUrl = 'https://github.com/danielcorin/thought-eddies';
const commitUrl = currentLog ? getCommitUrl(currentLog.filePath, repoUrl) : null;

// Helper function to format date with two-digit day using UTC
const formatDateWithPaddedDay = (date: Date): string => {
  const month = SHORT_MONTH_NAMES[date.getUTCMonth()];
  const day = String(date.getUTCDate()).padStart(2, "0");
  return `${month} ${day}`;
};

// Format current log date using parsed values (timezone-safe)
const currentLogFullDate = formatLogFullDate(logYear, logMonth, logDay);
---

<Layout title={frontmatter.title} ogImage={ogImage} pageType="logs">
  <Navigation selected="logs" />
  <main>
    <article>
      <Breadcrumbs items={[
        { label: "Logs", href: "/logs" },
        { label: String(logYear), href: `/logs/${logYear}` },
        { label: MONTH_NAMES[logMonth - 1], href: `/logs/${logYear}/${String(logMonth).padStart(2, "0")}` },
        { label: String(logDay).padStart(2, "0") }
      ]} />

      <nav class="day-navigation">
        <div class="nav-item nav-prev-wrapper">
          {
            prevLog && (
              <a href={`/logs/${prevLog.id}?ref=arrow_nav`} class="nav-prev">
                <Icon name="ph:arrow-left" />
                <span>
                  {formatDateWithPaddedDay(new Date(prevLog.data.date))}
                </span>
              </a>
            )
          }
        </div>
        <time class="current-day">
          {currentLogFullDate}
        </time>
        <div class="nav-item nav-next-wrapper">
          {
            nextLog && (
              <a href={`/logs/${nextLog.id}?ref=arrow_nav`} class="nav-next">
                <span>
                  {formatDateWithPaddedDay(new Date(nextLog.data.date))}
                </span>
                <Icon name="ph:arrow-right" />
              </a>
            )
          }
        </div>
      </nav>

      {
        frontmatter.location && (
          <ArticleMetadata location={frontmatter.location} />
        )
      }

      {
        frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="tags">
            {frontmatter.tags.map((tag: string) => (
              <Tag tag={tag} />
            ))}
          </div>
        )
      }

      <div class="content">
        <ClickableImages>
          <slot />
        </ClickableImages>
      </div>

      <div class="raw-link">
        <a href={`/logs/${slug.replace(/\.(md|mdx)$/, '')}/index.md`} class="raw-button">
          <Icon name="ph:code" />
          <span>raw</span>
        </a>
        <a href={`https://github.com/danielcorin/thought-eddies/edit/main/${currentLog?.filePath || `src/content/logs/${slug}`}`} target="_blank" rel="noopener noreferrer" class="edit-button">
          <Icon name="ph:pencil-simple" />
          <span>edit</span>
        </a>
        {commitUrl && (
          <a href={commitUrl} target="_blank" rel="noopener noreferrer" class="commit-button">
            <Icon name="ph:git-commit" />
            <span>commit</span>
          </a>
        )}
      </div>
    </article>
  </main>
</Layout>

<FullscreenImageViewer />

<style>
  /* Use base.css main and article styles, only add log-specific styles */

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }

  .tag {
    font-size: var(--text-sm);
    color: var(--color-ink-light);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .day-navigation {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    margin: var(--spacing-lg) 0;
    padding: var(--spacing-md);
    background: var(--color-bg-code);
    border-radius: 0.5rem;
  }

  .nav-item {
    display: flex;
  }

  .nav-prev-wrapper {
    justify-content: flex-start;
  }

  .nav-next-wrapper {
    justify-content: flex-end;
  }

  .nav-prev,
  .nav-next {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-sm);
    font-family: var(--font-mono);
  }

  .nav-prev svg,
  .nav-next svg {
    width: 1rem;
    height: 1rem;
  }

  .current-day {
    text-align: center;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
  }

  @media (max-width: 768px) {
    .day-navigation {
      gap: var(--spacing-xs);
      padding: var(--spacing-sm);
    }

    .current-day {
      font-size: var(--text-xs);
    }

    .nav-prev,
    .nav-next {
      font-size: var(--text-xs);
    }
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .raw-link {
    display: flex;
    justify-content: flex-start;
    gap: 0.75rem;
    margin-top: var(--spacing-xl);
  }

  .raw-button,
  .edit-button,
  .commit-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-bg-code);
    color: var(--color-ink);
    text-decoration: none;
    border-radius: 0.25rem;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    transition: background 0.2s, color 0.2s;
  }

  .raw-button:hover,
  .edit-button:hover,
  .commit-button:hover {
    background: var(--color-bg-hover);
    color: var(--color-accent);
  }

  .raw-button svg,
  .edit-button svg,
  .commit-button svg {
    width: 1rem;
    height: 1rem;
  }
</style>

<script>
  // Add keyboard navigation support
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      const prevLink = document.querySelector('.nav-prev') as HTMLAnchorElement;
      if (prevLink) {
        prevLink.click();
      }
    } else if (e.key === 'ArrowRight') {
      const nextLink = document.querySelector('.nav-next') as HTMLAnchorElement;
      if (nextLink) {
        nextLink.click();
      }
    }
  });
</script>
