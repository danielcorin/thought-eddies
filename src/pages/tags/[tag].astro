---
import Navigation from "@components/layout/Navigation.astro";
import PostCard from "@components/PostCard.astro";
import Layout from "@layouts/Layout.astro";
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";

export const getStaticPaths: GetStaticPaths = async () => {
  // Get all posts and logs
  const posts = await getCollection("posts");
  const logs = await getCollection("logs");
  
  // Extract all unique tags
  const allTags = new Set<string>();
  
  [...posts, ...logs].forEach(item => {
    if (item.data.tags && Array.isArray(item.data.tags)) {
      item.data.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // Generate paths for each tag
  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: { tag }
  }));
};

const { tag } = Astro.props;


// Get all content with this tag
const posts = await getCollection("posts");
const logs = await getCollection("logs");

// Filter and combine content
const taggedPosts = posts
  .filter(post => !post.data.draft && post.data.tags?.includes(tag))
  .map(post => ({
    ...post,
    type: 'post' as const,
    date: post.data.createdAt
  }));

const taggedLogs = logs
  .filter(log => !log.data.draft && log.data.tags?.includes(tag))
  .map(log => ({
    ...log,
    type: 'log' as const,
    date: log.data.date
  }));

// Combine and sort by date
const allTaggedContent = [...taggedPosts, ...taggedLogs]
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const ogImage = `/tags/${encodeURIComponent(tag)}/og.png`;
---

<Layout title={`Tag: ${tag}`} ogImage={ogImage}>
  <Navigation />
  <main>
    <h1 class="page-title">
      Tag: <span class="tag-highlight">{tag}</span>
      <span class="count">({allTaggedContent.length} {allTaggedContent.length === 1 ? 'item' : 'items'})</span>
    </h1>
    
    <div class="content-list">
      {allTaggedContent.map(item => (
        <PostCard post={item} type={item.type} showTypeLabel={true} />
      ))}
    </div>
    
    <div class="back-link">
      <a href="/tags">‚Üê All tags</a>
    </div>
  </main>
</Layout>

<style>
  .page-title {
    font-size: var(--text-3xl);
    margin-bottom: var(--spacing-lg);
  }
  
  .tag-highlight {
    color: var(--color-accent);
    font-weight: 600;
  }
  
  .count {
    font-size: var(--text-xl);
    color: var(--color-ink-light);
    font-weight: normal;
    margin-left: var(--spacing-sm);
  }
  
  .content-list {
    margin-top: var(--spacing-xl);
  }
  
  
  .back-link {
    margin-top: var(--spacing-xl);
    text-align: center;
  }
  
  .back-link a {
    color: var(--color-ink-light);
    text-decoration: none;
  }
  
  .back-link a:hover {
    color: var(--color-accent);
  }
</style>