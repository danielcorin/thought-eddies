---
import Navigation from "@components/layout/Navigation.astro";
import PostCard from "@components/PostCard.astro";
import Layout from "@layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import { slugify } from "@utils/slugify";

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection("posts");

  const seriesMap = new Map<string, string>();

  posts.forEach(post => {
    if (!post.data.draft && post.data.series) {
      seriesMap.set(slugify(post.data.series), post.data.series);
    }
  });

  return Array.from(seriesMap.entries()).map(([slug, name]) => ({
    params: { slug },
    props: { seriesName: name },
  }));
};

const { seriesName } = Astro.props;

const posts = await getCollection("posts");

const seriesPosts = posts
  .filter(post => !post.data.draft && post.data.series === seriesName)
  .sort((a, b) => new Date(a.data.createdAt).getTime() - new Date(b.data.createdAt).getTime());
---

<Layout title={`Series: ${seriesName}`}>
  <Navigation />
  <main>
    <div class="page-header">
      <h1 class="page-title">{seriesName}</h1>
      <p class="entry-count">{seriesPosts.length} {seriesPosts.length === 1 ? 'post' : 'posts'}</p>
    </div>

    <nav class="breadcrumb">
      <a href="/series">
        <Icon name="ph:arrow-left" />
        All series
      </a>
    </nav>

    {seriesPosts.map((post) => (
      <PostCard post={post} type="post" />
    ))}
  </main>
</Layout>

<style>
  .page-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
  }

  .page-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .page-title {
    font-size: var(--text-3xl);
  }

  .entry-count {
    color: var(--color-ink-light);
    font-size: var(--text-sm);
    margin: 0;
  }

  .breadcrumb {
    margin-bottom: var(--spacing-xl);
  }

  .breadcrumb a {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--color-accent);
    text-decoration: none;
    font-size: var(--text-sm);
  }

  .breadcrumb a svg {
    width: 1rem;
    height: 1rem;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }
</style>
