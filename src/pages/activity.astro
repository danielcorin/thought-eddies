---
import Navigation from '@components/layout/Navigation.astro';
import Layout from '@layouts/Layout.astro';
import ActivityPageClient from '@components/ActivityPageClient';
import { getCollection } from 'astro:content';

// Get date from query parameter or use current date
const url = new URL(Astro.request.url);
const dateParam = url.searchParams.get('date');
const now = dateParam ? new Date(dateParam) : new Date();

// Validate the date
if (isNaN(now.getTime())) {
  // If invalid date, redirect to current date
  return Astro.redirect('/activity');
}

// Format date as YYYY-MM-DD for the date input
const formatDateForInput = (date: Date): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Get all collections
const posts = await getCollection('posts');
const tils = await getCollection('til');
const logs = await getCollection('logs');
const projects = await getCollection('projects');
const garden = await getCollection('garden');

// Helper function to get date from various content types
function getContentDate(item: any): Date | null {
  if (item.data.publishedAt) return item.data.publishedAt;
  if (item.data.createdAt) return item.data.createdAt;
  if (item.data.date) return item.data.date;
  return null;
}

// Get content length (estimated by body length)
function getContentLength(item: any): number {
  try {
    // For items with body property
    if (item.body) {
      return item.body.length;
    }
    // Default estimate for items without accessible content
    return 1000;
  } catch {
    return 1000; // Default estimate on error
  }
}

// Filter out drafts and get all published content
const publishedPosts = posts.filter((post) => !post.data.draft && !post.id.includes('level'));
const publishedTils = tils.filter((til) => !til.data.draft);
const publishedLogs = logs.filter((log) => !log.data.draft);
const publishedProjects = projects.filter((project) => !project.data.draft);
const publishedGarden = garden.filter((item) => !item.data.draft);

// Prepare content data for client-side processing
const allContentData = [
  ...publishedPosts.map(item => ({
    id: item.id,
    collection: 'posts',
    publishedAt: getContentDate(item)?.toISOString(),
    contentLength: getContentLength(item),
  })),
  ...publishedTils.map(item => ({
    id: item.id,
    collection: 'til',
    publishedAt: getContentDate(item)?.toISOString(),
    contentLength: getContentLength(item),
  })),
  ...publishedLogs.map(item => ({
    id: item.id,
    collection: 'logs',
    publishedAt: getContentDate(item)?.toISOString(),
    contentLength: getContentLength(item),
  })),
  ...publishedProjects.map(item => ({
    id: item.id,
    collection: 'projects',
    publishedAt: getContentDate(item)?.toISOString(),
    contentLength: getContentLength(item),
  })),
  ...publishedGarden.map(item => ({
    id: item.id,
    collection: 'garden',
    publishedAt: getContentDate(item)?.toISOString(),
    contentLength: getContentLength(item),
  })),
].filter(item => item.publishedAt);
---

<Layout title="Site Activity">
  <Navigation />
  <main>
    <h1 class="page-title">Site Activity</h1>
    
    <ActivityPageClient 
      client:load
      allContent={allContentData}
      initialDate={formatDateForInput(now)}
    />
  </main>
</Layout>

<style>
  :global(.date-picker-container) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-md);
    background: var(--color-bg-code);
    border-radius: 0.5rem;
  }

  :global(.date-picker-container label) {
    color: var(--color-ink-light);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
  }

  :global(.date-picker) {
    background: var(--color-bg);
    color: var(--color-ink);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: var(--font-size-sm);
    font-family: var(--font-mono);
    transition: all 0.2s;
    cursor: pointer;
  }

  :global(.date-picker:hover) {
    border-color: var(--color-accent);
    background: var(--color-bg-code);
  }

  :global(.date-picker:focus) {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-alpha);
  }

  /* Style the calendar icon */
  :global(.date-picker::-webkit-calendar-picker-indicator) {
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  :global(.date-picker::-webkit-calendar-picker-indicator:hover) {
    opacity: 1;
  }

  /* Dark mode support for date picker */
  @media (prefers-color-scheme: dark) {
    :global(.date-picker::-webkit-calendar-picker-indicator) {
      filter: invert(1);
    }
  }

  :global(.today-button) {
    background: var(--color-bg);
    color: var(--color-ink);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: var(--font-size-sm);
    font-family: var(--font-mono);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  :global(.today-button:hover) {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-bg-code);
  }

  :global(.today-button:focus) {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-alpha);
  }

  :global(.today-button:active) {
    transform: translateY(1px);
  }

  :global(.stats-grid) {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    margin-top: var(--spacing-lg);
  }

  :global(.stat-card) {
    background: var(--color-bg-code);
    border-radius: 0.5rem;
    padding: var(--spacing-lg);
    text-align: center;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  :global(.stat-card h2) {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-sm);
    color: var(--color-ink-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  :global(.sparkline-container) {
    position: relative;
    margin-bottom: var(--spacing-sm);
  }

  :global(.sparkline) {
    width: 100%;
    height: 80px;
  }

  :global(.sparkline-legend) {
    display: flex;
    justify-content: center;
    gap: var(--spacing-lg);
    margin-top: var(--spacing-xs);
    font-size: var(--text-xs);
  }

  :global(.legend-item) {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--color-ink-light);
  }

  :global(.legend-line) {
    display: inline-block;
    width: 20px;
    height: 2px;
    border-radius: 1px;
  }

  :global(.legend-line.current) {
    background-color: var(--color-accent);
  }

  :global(.legend-line.previous) {
    background-color: var(--color-ink-light);
    opacity: 0.5;
  }

  :global(.legend-label) {
    font-size: var(--text-xs);
  }

  :global(.stat-header) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
  }

  :global(.stat-values) {
    display: flex;
    align-items: baseline;
    gap: var(--spacing-md);
  }

  :global(.stat-comparison) {
    display: flex;
    align-items: baseline;
    gap: var(--spacing-xs);
  }

  :global(.stat-previous) {
    font-size: var(--font-size-lg);
    color: var(--color-ink-light);
    opacity: 0.8;
  }
  
  :global(.stat-delta) {
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  :global(.stat-value) {
    font-size: var(--font-size-3xl);
    font-weight: 600;
    color: var(--color-accent);
  }

  :global(.stat-change) {
    font-size: var(--font-size-sm);
    font-weight: 500;
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
  }

  :global(.stat-change.positive) {
    color: var(--color-success, #10b981);
    background: var(--color-success-bg, #10b98120);
  }

  :global(.stat-change.negative) {
    color: var(--color-error, #ef4444);
    background: var(--color-error-bg, #ef444420);
  }
  
  :global(.stat-delta.positive) {
    color: var(--color-ink-light);
  }

  :global(.stat-delta.negative) {
    color: var(--color-ink-light);
  }

  :global(.stat-breakdown) {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    justify-content: center;
  }

  :global(.stat-item) {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    text-decoration: none;
    color: var(--color-ink);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    transition: all 0.2s;
  }

  :global(.stat-item:hover) {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  :global(.stat-label) {
    color: inherit;
  }

  :global(.stat-count) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5rem;
    height: 1.5rem;
    padding: 0 0.375rem;
    background: var(--color-bg-code);
    border-radius: 9999px;
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-ink-light);
  }

  :global(.stat-item:hover .stat-count) {
    background: var(--color-accent);
    color: var(--color-bg);
  }

  :global(.all-time-section) {
    margin-top: var(--spacing-2xl);
  }

  :global(.all-time-section h2) {
    font-size: var(--font-size-xl);
    margin-bottom: var(--spacing-lg);
    text-align: center;
  }

  :global(.all-time-stats) {
    background: var(--color-bg-code);
    border-radius: 0.5rem;
    padding: var(--spacing-xl);
    text-align: center;
  }

  :global(.all-time-total) {
    display: flex;
    justify-content: center;
    align-items: baseline;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }

  :global(.all-time-total .label) {
    font-size: var(--font-size-lg);
    color: var(--color-ink-light);
  }

  :global(.all-time-total .value) {
    font-size: var(--font-size-4xl);
    font-weight: 600;
    color: var(--color-ink);
  }

  :global(.all-time-breakdown) {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--spacing-md);
  }

  :global(.all-time-item) {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    text-decoration: none;
    color: var(--color-ink);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    transition: all 0.2s;
  }

  :global(.all-time-item:hover) {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  :global(.all-time-label) {
    color: inherit;
  }

  :global(.all-time-count) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5rem;
    height: 1.5rem;
    padding: 0 0.375rem;
    background: var(--color-bg-code);
    border-radius: 9999px;
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-ink-light);
  }

  :global(.all-time-item:hover .all-time-count) {
    background: var(--color-accent);
    color: var(--color-bg);
  }

  @media (max-width: 768px) {
    :global(.stats-grid) {
      grid-template-columns: 1fr;
    }

    :global(.stat-card) {
      padding: var(--spacing-md);
    }

    :global(.stat-value) {
      font-size: var(--font-size-2xl);
    }

    :global(.all-time-total .value) {
      font-size: var(--font-size-3xl);
    }

    :global(.date-picker-container) {
      flex-direction: column;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
    }

    :global(.date-picker) {
      width: 100%;
      max-width: 200px;
    }
  }
</style>
