---
import { Markdown } from '@astropub/md';
import { Icon } from 'astro-icon/components';

interface Props {
  role: 'system' | 'user' | 'assistant';
  model?: string;
  timestamp?: string;
}

const { role, model, timestamp } = Astro.props;

type ContentBlock =
  | { type: 'text'; content: string }
  | { type: 'image'; src: string; alt?: string }
  | { type: 'iframe'; src: string; title?: string; width?: string; height?: string }
  | { type: 'tool_call'; name: string; input: string; output: string };

function decodeHtmlEntities(str: string): string {
  return str
    .replace(/&#34;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"');
}

// Helper to parse content into ordered blocks of text, images, iframes, and tool calls
function parseContentBlocks(slotContent: string): ContentBlock[] {
  const blocks: ContentBlock[] = [];

  // Match img tags, iframe tags, and tool-call tags (with content)
  // For tool-call, use attribute-aware matching that handles > inside quoted values
  const mediaRegex = /<(img|iframe)\s+[^>]*?(?:\/>|><\/\1>|>)|<tool-call\s+(?:[^>"']|"[^"]*"|'[^']*')*?>[\s\S]*?<\/tool-call>/gi;

  let lastIndex = 0;
  let match;

  while ((match = mediaRegex.exec(slotContent)) !== null) {
    // Add text before this element if any
    const textBefore = slotContent.slice(lastIndex, match.index).trim();
    if (textBefore) {
      blocks.push({ type: 'text', content: textBefore });
    }

    const fullMatch = match[0];

    if (fullMatch.startsWith('<tool-call')) {
      const nameMatch = fullMatch.match(/name="([^"]*)"|name='([^']*)'/);
      const inputMatch = fullMatch.match(/input="([^"]*)"|input='([^']*)'/);
      // Content between the closing > of opening tag and </tool-call> is the output
      const contentMatch = fullMatch.match(/<tool-call\s+(?:[^>"']|"[^"]*"|'[^']*')*?>([\s\S]*?)<\/tool-call>/);

      blocks.push({
        type: 'tool_call',
        name: decodeHtmlEntities((nameMatch?.[1] ?? nameMatch?.[2]) || 'Tool'),
        input: decodeHtmlEntities((inputMatch?.[1] ?? inputMatch?.[2]) || ''),
        output: decodeHtmlEntities(contentMatch?.[1]?.trim() || '(No content)'),
      });
    } else {
      const tagName = match[1]?.toLowerCase();
      const tag = fullMatch;

      if (tagName === 'img') {
        const srcMatch = tag.match(/src=["']([^"']+)["']/);
        const altMatch = tag.match(/alt=["']([^"']+)["']/);

        if (srcMatch) {
          blocks.push({
            type: 'image',
            src: srcMatch[1],
            alt: altMatch?.[1]
          });
        }
      } else if (tagName === 'iframe') {
        const srcMatch = tag.match(/src=["']([^"']+)["']/);
        const titleMatch = tag.match(/title=["']([^"']+)["']/);
        const widthMatch = tag.match(/width=["']([^"']+)["']/);
        const heightMatch = tag.match(/height=["']([^"']+)["']/);

        if (srcMatch) {
          blocks.push({
            type: 'iframe',
            src: srcMatch[1],
            title: titleMatch?.[1],
            width: widthMatch?.[1],
            height: heightMatch?.[1]
          });
        }
      }
    }

    lastIndex = match.index + fullMatch.length;
  }

  // Add any remaining text after the last element
  const remainingText = slotContent.slice(lastIndex).trim();
  if (remainingText) {
    blocks.push({ type: 'text', content: remainingText });
  }

  return blocks;
}

const defaultContent = await Astro.slots.render('default');
const thinkingContent = await Astro.slots.render('thinking');

const contentBlocks = parseContentBlocks(defaultContent);
const thinking = thinkingContent ? [thinkingContent] : [];

function formatToolInputPreview(input: string): string {
  return input.length > 80 ? input.slice(0, 80) + '...' : input;
}
---

<>
  {timestamp && (
    <div class="timestamp-divider">
      <span class="timestamp-text">{timestamp}</span>
    </div>
  )}
  <div class="message-container">
    {role === 'user' && (
      <div class="message user">
        <div class="message-content">
          <div class="user-label">User</div>
          <div class="bubble user-bubble">
            {contentBlocks.map((block, index) => (
              block.type === 'text' ? (
                <Markdown of={block.content} />
              ) : block.type === 'image' ? (
                <img
                  src={block.src}
                  alt={block.alt || `Image ${index + 1} from user message`}
                  class="message-image"
                />
              ) : (
                <iframe
                  src={block.src}
                  title={block.title || `Embedded content ${index + 1}`}
                  width={block.width || '100%'}
                  height={block.height || '450'}
                  class="message-iframe"
                />
              )
            ))}
          </div>
        </div>
      </div>
    )}
    {role === 'assistant' && (
      <div class="message assistant">
        <div class="message-content">
          <div class="model-label">{model || 'Assistant'}</div>
          {thinking.length > 0 && (
            <details class="thinking-container">
              <summary class="thinking-summary">
                <Icon name="ph:caret-right" class="thinking-chevron" />
                Thinking process
              </summary>
              <div class="thinking-content">
                {thinking.map((thought) => (
                  <Markdown of={thought} />
                ))}
              </div>
            </details>
          )}
          {contentBlocks.map((block, index) => (
            block.type === 'tool_call' ? (
              <details class="tool-call-container">
                <summary class="tool-call-summary">
                  <Icon name="ph:caret-right" class="tool-call-chevron" />
                  <span class="tool-call-name">{block.name}</span>
                  <span class="tool-call-input-preview">{formatToolInputPreview(block.input)}</span>
                </summary>
                <div class="tool-call-detail">
                  {block.input && (
                    <div class="tool-call-input">
                      <div class="tool-call-label">Input</div>
                      <pre><code>{block.input}</code></pre>
                    </div>
                  )}
                  <div class="tool-call-output">
                    <div class="tool-call-label">Output</div>
                    <pre><code>{block.output}</code></pre>
                  </div>
                </div>
              </details>
            ) : block.type === 'text' ? (
              <div class="bubble assistant-bubble">
                <Markdown of={block.content} />
              </div>
            ) : block.type === 'image' ? (
              <div class="bubble assistant-bubble">
                <img
                  src={block.src}
                  alt={block.alt || `Image ${index + 1} from ${model || 'assistant'} response`}
                  class="message-image"
                />
              </div>
            ) : (
              <div class="bubble assistant-bubble">
                <iframe
                  src={block.src}
                  title={block.title || `Embedded content ${index + 1}`}
                  width={block.width || '100%'}
                  height={block.height || '450'}
                  class="message-iframe"
                />
              </div>
            )
          ))}
        </div>
      </div>
    )}
    {role === 'system' && (
      <div class="message system">
        <div class="bubble system-bubble">
          {contentBlocks.map((block, index) => (
            block.type === 'text' ? (
              <Markdown of={block.content} />
            ) : block.type === 'image' ? (
              <img
                src={block.src}
                alt={block.alt || `Image ${index + 1} from system message`}
                class="message-image"
              />
            ) : (
              <iframe
                src={block.src}
                title={block.title || `Embedded content ${index + 1}`}
                width={block.width || '100%'}
                height={block.height || '450'}
                class="message-iframe"
              />
            )
          ))}
        </div>
      </div>
    )}
  </div>
</>

<style>
  /* Reuse all the styles from Chat.astro */
  .message-container {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .message {
    display: flex;
  }

  .message.user {
    justify-content: flex-end;
  }
  .message.assistant {
    justify-content: flex-start;
  }
  .message.system {
    justify-content: center;
  }

  .message-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-width: 80%;
    min-width: 0;
  }

  .message.user .message-content {
    align-items: flex-end;
  }

  .bubble {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    max-width: 100%;
    font-size: var(--text-sm);
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-width: 0;
    display: inline-block;
    width: fit-content;
  }

  /* Ensure proper paragraph spacing in all bubbles */
  .bubble :global(p) {
    margin: 0.75rem 0;
  }

  .bubble :global(p:first-child) {
    margin-top: 0;
  }

  .bubble :global(p:last-child) {
    margin-bottom: 0;
  }

  .user-bubble {
    background: var(--color-ink-light);
    color: var(--color-bg);
    border-bottom-right-radius: 0;
    text-align: left;
  }

  .assistant-bubble {
    background: var(--color-bg-code);
    color: var(--color-ink);
    border-bottom-left-radius: 0;
    text-align: left;
  }

  .system-bubble {
    background: var(--color-bg-code);
    color: var(--color-ink-light);
    font-style: italic;
    text-align: left;
  }

  .model-label,
  .user-label {
    font-size: var(--text-xs);
    color: var(--color-ink-light);
    margin-left: 0.5rem;
  }

  .user-label {
    text-align: right;
    margin-bottom: 0.25rem;
  }

  .timestamp-divider {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: var(--spacing-sm) 0;
    position: relative;
  }

  .timestamp-text {
    font-size: var(--text-xs);
    color: var(--color-ink-lighter);
    background: var(--color-bg);
    padding: 0 var(--spacing-sm);
    position: relative;
    z-index: 1;
  }

  .message-image {
    margin-top: 0.5rem;
    border-radius: 0.5rem;
    max-width: 100%;
    max-height: 500px;
    object-fit: contain;
  }

  .message-iframe {
    margin-top: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
    max-width: 100%;
    background: #fff;
    display: block;
  }

  /* Ensure text colors respect dark mode */
  .user-bubble :global(p),
  .user-bubble :global(li),
  .user-bubble :global(h1),
  .user-bubble :global(h2),
  .user-bubble :global(h3),
  .user-bubble :global(h4),
  .user-bubble :global(h5),
  .user-bubble :global(h6) {
    color: var(--color-bg);
  }

  .assistant-bubble :global(p),
  .assistant-bubble :global(li),
  .assistant-bubble :global(h1),
  .assistant-bubble :global(h2),
  .assistant-bubble :global(h3),
  .assistant-bubble :global(h4),
  .assistant-bubble :global(h5),
  .assistant-bubble :global(h6) {
    color: var(--color-ink);
  }

  .system-bubble :global(p),
  .system-bubble :global(li),
  .system-bubble :global(h1),
  .system-bubble :global(h2),
  .system-bubble :global(h3),
  .system-bubble :global(h4),
  .system-bubble :global(h5),
  .system-bubble :global(h6) {
    color: var(--color-ink-light);
  }

  /* Ensure links in bubbles have appropriate colors */
  .user-bubble :global(a) {
    color: var(--color-bg);
    text-decoration: underline;
  }

  .assistant-bubble :global(a) {
    color: var(--color-link);
    text-decoration: underline;
  }

  .system-bubble :global(a) {
    color: var(--color-ink-light);
    text-decoration: underline;
  }

  /* Inline code styling within bubbles */
  .user-bubble :global(code:not(pre code)) {
    background-color: rgba(255, 255, 255, 0.2);
    color: var(--color-bg);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .assistant-bubble :global(code:not(pre code)) {
    background-color: rgba(0, 0, 0, 0.08);
    color: var(--color-ink);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  /* Dark mode adjustments for inline code */
  :global(.dark) .assistant-bubble :global(code:not(pre code)) {
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Code block styling within bubbles */
  .bubble :global(pre) {
    margin: 0.5rem 0;
    overflow-x: auto;
    max-width: 100%;
    min-width: 0;
  }

  .bubble :global(pre code) {
    display: block;
    white-space: pre;
    word-break: normal;
    overflow-wrap: normal;
    min-width: 0;
  }

  /* Thinking content styles */
  .thinking-container {
    margin-bottom: 0.5rem;
    background: var(--color-bg-code);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: var(--text-sm);
    opacity: 0.8;
  }

  .thinking-summary {
    cursor: pointer;
    font-size: var(--text-xs);
    color: var(--color-ink-light);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .thinking-summary::-webkit-details-marker {
    display: none;
  }

  .thinking-chevron {
    width: 1em;
    height: 1em;
    transition: transform 0.2s ease;
  }

  details[open] .thinking-chevron {
    transform: rotate(90deg);
  }

  .thinking-content {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-ink-light);
  }

  .thinking-content :global(p) {
    margin: 0.5rem 0;
  }

  .thinking-content :global(p:first-child) {
    margin-top: 0;
  }

  .thinking-content :global(p:last-child) {
    margin-bottom: 0;
  }

  /* Tool call styles */
  .tool-call-container {
    background: var(--color-bg-code);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: var(--text-sm);
    opacity: 0.8;
  }

  .tool-call-summary {
    cursor: pointer;
    font-size: var(--text-xs);
    color: var(--color-ink-light);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    overflow: hidden;
  }

  .tool-call-summary::-webkit-details-marker {
    display: none;
  }

  .tool-call-chevron {
    width: 1em;
    height: 1em;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  details[open] .tool-call-chevron {
    transform: rotate(90deg);
  }

  .tool-call-name {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--color-ink);
    flex-shrink: 0;
  }

  .tool-call-input-preview {
    color: var(--color-ink-lighter);
    font-family: var(--font-mono);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .tool-call-detail {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
  }

  .tool-call-label {
    font-size: var(--text-xs);
    color: var(--color-ink-lighter);
    margin-bottom: 0.25rem;
    font-weight: 600;
  }

  .tool-call-input,
  .tool-call-output {
    margin-bottom: 0.5rem;
  }

  .tool-call-output:last-child {
    margin-bottom: 0;
  }

  .tool-call-detail pre {
    margin: 0;
    padding: 0.5rem;
    background: var(--color-bg);
    border-radius: 0.25rem;
    overflow-x: auto;
    font-size: var(--text-xs);
  }

  .tool-call-detail pre code {
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Mobile styles */
  @media (max-width: 640px) {
    .message-content {
      max-width: 100%;
    }

    .message.user,
    .message.assistant,
    .message.system {
      justify-content: stretch;
    }

    .bubble {
      width: 100%;
      display: block;
      max-width: 100%;
    }

    .message-content {
      width: 100%;
    }

    .message.user .message-content {
      align-items: stretch;
    }

    .user-label {
      text-align: right;
    }

    .user-bubble,
    .assistant-bubble,
    .system-bubble {
      width: 100%;
    }

    .user-bubble {
      border-radius: 1rem;
      border-bottom-right-radius: 0;
    }

    .assistant-bubble {
      border-radius: 1rem;
      border-bottom-left-radius: 0;
    }
  }
</style>

<script>
  // Resize iframes based on their content dimensions
  function resizeIframes() {
    const iframes = document.querySelectorAll('.message-iframe');
    iframes.forEach((iframe) => {
      iframe.addEventListener('load', () => {
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
          if (iframeDoc) {
            const body = iframeDoc.body;
            const html = iframeDoc.documentElement;

            // Get the actual content dimensions
            const contentWidth = Math.max(
              body.scrollWidth,
              body.offsetWidth,
              html.scrollWidth,
              html.offsetWidth
            );
            const contentHeight = Math.max(
              body.scrollHeight,
              body.offsetHeight,
              html.scrollHeight,
              html.offsetHeight
            );

            // Set iframe dimensions, respecting max-width from CSS
            iframe.style.width = contentWidth + 'px';
            iframe.style.height = contentHeight + 'px';
          }
        } catch (e) {
          // Cross-origin iframes will throw - fall back to default dimensions
          console.debug('Could not resize iframe (likely cross-origin):', e);
        }
      });
    });
  }

  // Run on initial load
  resizeIframes();

  // Also run when navigating (for Astro view transitions)
  document.addEventListener('astro:page-load', resizeIframes);
</script>
